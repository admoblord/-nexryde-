<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXRYDE Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0F172A;
            color: #FFFFFF;
            min-height: 100vh;
        }
        
        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
        }
        .login-box {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 48px;
            width: 100%;
            max-width: 420px;
        }
        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }
        .login-logo h1 {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #00E676, #00C853);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .login-logo p {
            color: #94A3B8;
            margin-top: 8px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            color: #94A3B8;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #FFFFFF;
            font-size: 15px;
            transition: all 0.2s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #6366F1;
            background: rgba(99,102,241,0.1);
        }
        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #6366F1, #8B5CF6);
            border: none;
            border-radius: 12px;
            color: #FFFFFF;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(99,102,241,0.3);
        }
        .login-error {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            color: #EF4444;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        /* Dashboard */
        .dashboard { display: none; }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: #1E293B;
            border-right: 1px solid rgba(255,255,255,0.05);
            padding: 24px 0;
        }
        .sidebar-logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .sidebar-logo h2 {
            font-size: 22px;
            font-weight: 800;
            color: #00E676;
        }
        .sidebar-logo span {
            font-size: 12px;
            color: #64748B;
        }
        .nav-menu {
            padding: 24px 12px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            color: #94A3B8;
            text-decoration: none;
            border-radius: 12px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(99,102,241,0.15);
            color: #FFFFFF;
        }
        .nav-item.active {
            background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(139,92,246,0.2));
        }
        .nav-item i {
            font-size: 20px;
            margin-right: 12px;
        }
        
        .main-content {
            margin-left: 260px;
            padding: 24px;
            min-height: 100vh;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .admin-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.05);
            padding: 10px 16px;
            border-radius: 12px;
        }
        .admin-badge i {
            color: #00E676;
        }
        .logout-btn {
            background: rgba(239,68,68,0.1);
            color: #EF4444;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
        }
        .stat-card .icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }
        .stat-card .icon.green { background: rgba(0,230,118,0.15); color: #00E676; }
        .stat-card .icon.blue { background: rgba(99,102,241,0.15); color: #6366F1; }
        .stat-card .icon.purple { background: rgba(139,92,246,0.15); color: #8B5CF6; }
        .stat-card .icon.orange { background: rgba(245,158,11,0.15); color: #F59E0B; }
        .stat-card .value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 4px;
        }
        .stat-card .label {
            color: #64748B;
            font-size: 14px;
        }
        
        /* Tables */
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-header h3 {
            font-size: 18px;
            font-weight: 700;
        }
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge.green { background: rgba(0,230,118,0.15); color: #00E676; }
        .badge.yellow { background: rgba(245,158,11,0.15); color: #F59E0B; }
        .badge.red { background: rgba(239,68,68,0.15); color: #EF4444; }
        .badge.blue { background: rgba(99,102,241,0.15); color: #6366F1; }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        th {
            color: #64748B;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
        }
        td {
            font-size: 14px;
        }
        tr:hover {
            background: rgba(255,255,255,0.02);
        }
        
        .action-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }
        .action-btn.approve {
            background: rgba(0,230,118,0.15);
            color: #00E676;
        }
        .action-btn.view {
            background: rgba(99,102,241,0.15);
            color: #6366F1;
        }
        .action-btn.block {
            background: rgba(239,68,68,0.15);
            color: #EF4444;
        }
        
        /* Page Sections */
        .page-section { display: none; }
        .page-section.active { display: block; }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px;
            color: #64748B;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        .modal-content {
            background: #1E293B;
            border-radius: 20px;
            padding: 32px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .modal-header h3 {
            font-size: 20px;
            font-weight: 700;
        }
        .modal-close {
            background: none;
            border: none;
            color: #94A3B8;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-logo">
                <h1>NEXRYDE</h1>
                <p>Admin Panel</p>
            </div>
            <div class="login-error" id="loginError">Invalid credentials</div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="admin@nexryde.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter password" required>
                </div>
                <button type="submit" class="login-btn">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>NEXRYDE</h2>
                <span>Admin Panel</span>
            </div>
            <nav class="nav-menu">
                <a class="nav-item active" data-page="overview">
                    <i class="ri-dashboard-line"></i> Overview
                </a>
                <a class="nav-item" data-page="riders">
                    <i class="ri-user-line"></i> Riders
                </a>
                <a class="nav-item" data-page="drivers">
                    <i class="ri-steering-2-line"></i> Drivers
                </a>
                <a class="nav-item" data-page="trips">
                    <i class="ri-road-map-line"></i> Trips
                </a>
                <a class="nav-item" data-page="payments">
                    <i class="ri-bank-card-line"></i> Payments
                </a>
                <a class="nav-item" data-page="verifications">
                    <i class="ri-shield-check-line"></i> Verifications
                </a>
                <a class="nav-item" data-page="promos">
                    <i class="ri-coupon-line"></i> Promo Codes
                </a>
                <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 16px 0; padding-top: 16px;">
                    <span style="font-size: 11px; color: #64748B; padding: 0 16px; text-transform: uppercase; letter-spacing: 1px;">Enhanced Features</span>
                </div>
                <a class="nav-item" data-page="fraud">
                    <i class="ri-alarm-warning-line"></i> Fraud Alerts
                </a>
                <a class="nav-item" data-page="users">
                    <i class="ri-user-search-line"></i> User Management
                </a>
                <a class="nav-item" data-page="livetrips">
                    <i class="ri-live-line"></i> Live Trips
                </a>
                <a class="nav-item" data-page="analytics">
                    <i class="ri-bar-chart-box-line"></i> Analytics
                </a>
                <a class="nav-item" data-page="community">
                    <i class="ri-group-line"></i> Community
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1 id="pageTitle">Dashboard Overview</h1>
                <div class="header-actions">
                    <div class="admin-badge">
                        <i class="ri-shield-user-line"></i>
                        <span>Admin</span>
                    </div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Overview Page -->
            <div class="page-section active" id="page-overview">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon green"><i class="ri-user-line"></i></div>
                        <div class="value" id="totalRiders">0</div>
                        <div class="label">Total Riders</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon blue"><i class="ri-steering-2-line"></i></div>
                        <div class="value" id="totalDrivers">0</div>
                        <div class="label">Total Drivers</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon purple"><i class="ri-road-map-line"></i></div>
                        <div class="value" id="totalTrips">0</div>
                        <div class="label">Total Trips</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon orange"><i class="ri-money-dollar-circle-line"></i></div>
                        <div class="value" id="totalRevenue">‚Ç¶0</div>
                        <div class="label">Revenue (Subscriptions)</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Recent Activity</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>User</th>
                                <th>Details</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivity">
                            <tr><td colspan="4" class="empty-state"><i class="ri-inbox-line"></i><p>No recent activity</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Riders Page -->
            <div class="page-section" id="page-riders">
                <div class="card">
                    <div class="card-header">
                        <h3>All Riders</h3>
                        <span class="badge blue" id="riderCount">0 riders</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Trips</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ridersTable">
                            <tr><td colspan="6" class="empty-state"><i class="ri-user-line"></i><p>No riders yet</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Drivers Page -->
            <div class="page-section" id="page-drivers">
                <div class="card">
                    <div class="card-header">
                        <h3>All Drivers</h3>
                        <span class="badge green" id="driverCount">0 drivers</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Vehicle</th>
                                <th>Subscription</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="driversTable">
                            <tr><td colspan="6" class="empty-state"><i class="ri-steering-2-line"></i><p>No drivers yet</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Trips Page -->
            <div class="page-section" id="page-trips">
                <div class="card">
                    <div class="card-header">
                        <h3>All Trips</h3>
                        <span class="badge purple" id="tripCount">0 trips</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Rider</th>
                                <th>Driver</th>
                                <th>Route</th>
                                <th>Fare</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tripsTable">
                            <tr><td colspan="6" class="empty-state"><i class="ri-road-map-line"></i><p>No trips yet</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payments Page -->
            <div class="page-section" id="page-payments">
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="icon green"><i class="ri-checkbox-circle-line"></i></div>
                        <div class="value" id="approvedPayments">0</div>
                        <div class="label">Approved</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon yellow"><i class="ri-time-line"></i></div>
                        <div class="value" id="pendingPayments">0</div>
                        <div class="label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon purple"><i class="ri-money-dollar-circle-line"></i></div>
                        <div class="value" id="totalSubscriptionRevenue">‚Ç¶0</div>
                        <div class="label">Total Revenue</div>
                    </div>
                </div>
                
                <!-- Auto-Approval Info Card -->
                <div class="card" style="background: linear-gradient(135deg, rgba(0,230,118,0.15), rgba(34,197,94,0.1)); border-color: rgba(0,230,118,0.3); margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 56px; height: 56px; border-radius: 14px; background: rgba(0,230,118,0.2); display: flex; align-items: center; justify-content: center;">
                            <i class="ri-flashlight-line" style="font-size: 28px; color: #00E676;"></i>
                        </div>
                        <div style="flex: 1;">
                            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 4px; color: #00E676;">Instant Auto-Approval Active</h3>
                            <p style="color: #94A3B8; font-size: 14px;">Driver subscriptions are automatically approved when payment screenshot is uploaded. All payments are logged below for your records.</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: #64748B;">Bank Account</div>
                            <div style="font-size: 15px; font-weight: 700; color: #FFFFFF;">UBA ‚Ä¢ 1028400669</div>
                            <div style="font-size: 13px; color: #94A3B8;">ADMOBLORDGROUP LIMITED</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>Subscription Payments</h3>
                        <span class="badge green">Auto-Approved</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Driver</th>
                                <th>Amount</th>
                                <th>Proof</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTable">
                            <tr><td colspan="6" class="empty-state"><i class="ri-bank-card-line"></i><p>No payments yet</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Verifications Page -->
            <div class="page-section" id="page-verifications">
                <div class="card">
                    <div class="card-header">
                        <h3>Driver Verifications</h3>
                        <span class="badge blue" id="verificationCount">0 pending</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Driver</th>
                                <th>Phone</th>
                                <th>Documents</th>
                                <th>Vehicle</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="verificationsTable">
                            <tr><td colspan="6" class="empty-state"><i class="ri-shield-check-line"></i><p>No pending verifications</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Promos Page -->
            <div class="page-section" id="page-promos">
                <div class="card">
                    <div class="card-header">
                        <h3>Promo Codes</h3>
                        <button class="action-btn view" onclick="showCreatePromo()">+ Create New</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Discount</th>
                                <th>Used</th>
                                <th>Max Uses</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="promosTable">
                            <tr><td colspan="5" class="empty-state"><i class="ri-coupon-line"></i><p>No promo codes yet</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- FRAUD ALERTS PAGE -->
            <div class="page-section" id="page-fraud">
                <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);">
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(239,68,68,0.15); color: #EF4444;"><i class="ri-alarm-warning-line"></i></div>
                        <div class="value" id="fraudTotal">0</div>
                        <div class="label">Total Alerts</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(239,68,68,0.15); color: #EF4444;"><i class="ri-error-warning-line"></i></div>
                        <div class="value" id="fraudCritical">0</div>
                        <div class="label">Critical</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(249,115,22,0.15); color: #F97316;"><i class="ri-alert-line"></i></div>
                        <div class="value" id="fraudHigh">0</div>
                        <div class="label">High</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(234,179,8,0.15); color: #EAB308;"><i class="ri-information-line"></i></div>
                        <div class="value" id="fraudMedium">0</div>
                        <div class="label">Medium</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(34,197,94,0.15); color: #22C55E;"><i class="ri-checkbox-circle-line"></i></div>
                        <div class="value" id="fraudLow">0</div>
                        <div class="label">Low</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>üö® Fraud Alerts</h3>
                        <span id="fraudMessage" style="color: #94A3B8; font-size: 14px;"></span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Severity</th>
                                <th>Details</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fraudTable">
                            <tr><td colspan="4" class="empty-state"><i class="ri-shield-check-line"></i><p>No fraud alerts</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- USER MANAGEMENT PAGE -->
            <div class="page-section" id="page-users">
                <div class="card">
                    <div class="card-header">
                        <h3>üîç User Management</h3>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="text" id="userSearchInput" placeholder="Search by name, phone, email..." style="padding: 10px 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; width: 300px;">
                            <select id="userRoleFilter" style="padding: 10px 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                                <option value="">All Roles</option>
                                <option value="rider">Riders</option>
                                <option value="driver">Drivers</option>
                            </select>
                            <button class="action-btn view" onclick="searchUsers()">Search</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Trips</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr><td colspan="7" class="empty-state"><i class="ri-user-search-line"></i><p>Search for users</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- LIVE TRIPS PAGE -->
            <div class="page-section" id="page-livetrips">
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="icon green"><i class="ri-car-line"></i></div>
                        <div class="value" id="liveTripsCount">0</div>
                        <div class="label">Active Trips</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(249,115,22,0.15); color: #F97316;"><i class="ri-time-line"></i></div>
                        <div class="value" id="longTripsCount">0</div>
                        <div class="label">Long Trips (2h+)</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon blue"><i class="ri-refresh-line"></i></div>
                        <div class="value" id="lastRefresh">-</div>
                        <div class="label">Last Updated</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>üöó Live Trips</h3>
                        <button class="action-btn view" onclick="loadLiveTrips()"><i class="ri-refresh-line"></i> Refresh</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Trip ID</th>
                                <th>Driver</th>
                                <th>Rider</th>
                                <th>Status</th>
                                <th>Duration</th>
                                <th>Alert</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="liveTripsTable">
                            <tr><td colspan="7" class="empty-state"><i class="ri-car-line"></i><p>No active trips</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ANALYTICS PAGE -->
            <div class="page-section" id="page-analytics">
                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <button class="action-btn view" onclick="loadAnalytics('today')" id="btn-today">Today</button>
                    <button class="action-btn" onclick="loadAnalytics('week')" id="btn-week">This Week</button>
                    <button class="action-btn" onclick="loadAnalytics('month')" id="btn-month">This Month</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon purple"><i class="ri-road-map-line"></i></div>
                        <div class="value" id="analyticsTrips">0</div>
                        <div class="label">Total Trips</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon green"><i class="ri-check-double-line"></i></div>
                        <div class="value" id="analyticsCompleted">0</div>
                        <div class="label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(239,68,68,0.15); color: #EF4444;"><i class="ri-close-circle-line"></i></div>
                        <div class="value" id="analyticsCancelRate">0%</div>
                        <div class="label">Cancel Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(234,179,8,0.15); color: #EAB308;"><i class="ri-money-dollar-circle-line"></i></div>
                        <div class="value" id="analyticsRevenue">‚Ç¶0</div>
                        <div class="label">Revenue</div>
                    </div>
                </div>
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <div class="icon blue"><i class="ri-route-line"></i></div>
                        <div class="value" id="analyticsAvgDistance">0 km</div>
                        <div class="label">Avg Distance</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon purple"><i class="ri-timer-line"></i></div>
                        <div class="value" id="analyticsAvgDuration">0 min</div>
                        <div class="label">Avg Duration</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(249,115,22,0.15); color: #F97316;"><i class="ri-fire-line"></i></div>
                        <div class="value" id="analyticsPeakHour">-</div>
                        <div class="label">Peak Hour</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>üìä Insights</h3>
                    </div>
                    <div id="analyticsInsights" style="padding: 16px;">
                        <p style="color: #64748B;">Select a period to view insights</p>
                    </div>
                </div>
            </div>

            <!-- COMMUNITY PAGE -->
            <div class="page-section" id="page-community">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon green"><i class="ri-team-line"></i></div>
                        <div class="value" id="communityDrivers">0</div>
                        <div class="label">Total Drivers</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon blue"><i class="ri-user-voice-line"></i></div>
                        <div class="value" id="communityActive">0</div>
                        <div class="label">Active (7 days)</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon purple"><i class="ri-article-line"></i></div>
                        <div class="value" id="communityPosts">0</div>
                        <div class="label">Posts</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(234,179,8,0.15); color: #EAB308;"><i class="ri-calendar-event-line"></i></div>
                        <div class="value" id="communityEvents">0</div>
                        <div class="label">Events</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="card">
                        <div class="card-header">
                            <h3>üìÖ Upcoming Events</h3>
                        </div>
                        <div id="communityEventsList" style="padding: 16px;">
                            <p style="color: #64748B;">No upcoming events</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>üë• Community Groups</h3>
                        </div>
                        <div id="communityGroupsList" style="padding: 16px;">
                            <p style="color: #64748B;">No groups yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Promo Modal -->
    <div class="modal-overlay" id="promoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Promo Code</h3>
                <button class="modal-close" onclick="closePromoModal()">&times;</button>
            </div>
            <form id="promoForm">
                <div class="form-group">
                    <label>Promo Code</label>
                    <input type="text" id="promoCode" placeholder="e.g., SAVE20" required style="text-transform:uppercase;">
                </div>
                <div class="form-group">
                    <label>Discount Percentage</label>
                    <input type="number" id="promoDiscount" placeholder="e.g., 20" min="1" max="100" required>
                </div>
                <div class="form-group">
                    <label>Max Uses</label>
                    <input type="number" id="promoMaxUses" placeholder="e.g., 1000" min="1" required>
                </div>
                <button type="submit" class="login-btn">Create Promo Code</button>
            </form>
        </div>
    </div>

    <!-- Screenshot Modal -->
    <div class="modal-overlay" id="screenshotModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Payment Proof</h3>
                <button class="modal-close" onclick="closeScreenshotModal()">&times;</button>
            </div>
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 16px; padding: 16px; background: rgba(0,0,0,0.3); border-radius: 12px;">
                    <div>
                        <div style="font-size: 12px; color: #64748B;">Driver</div>
                        <div style="font-size: 16px; font-weight: 700;" id="screenshotDriverName">-</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: #64748B;">Amount</div>
                        <div style="font-size: 16px; font-weight: 700; color: #00E676;" id="screenshotAmount">-</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: #64748B;">Submitted</div>
                        <div style="font-size: 14px;" id="screenshotDate">-</div>
                    </div>
                </div>
                <div style="background: #000; border-radius: 16px; overflow: hidden; text-align: center;">
                    <img id="screenshotImage" src="" alt="Payment Proof" style="max-width: 100%; max-height: 500px; object-fit: contain;">
                </div>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="action-btn approve" style="flex: 1; padding: 14px;" onclick="approveFromModal()">
                    <i class="ri-check-line"></i> Approve Payment
                </button>
                <button class="action-btn block" style="flex: 1; padding: 14px;" onclick="rejectFromModal()">
                    <i class="ri-close-line"></i> Reject Payment
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let adminToken = localStorage.getItem('adminToken');

        // Check if logged in
        if (adminToken) {
            showDashboard();
        }

        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const res = await fetch(`${API_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    adminToken = data.token;
                    localStorage.setItem('adminToken', adminToken);
                    showDashboard();
                } else {
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('loginError').textContent = data.detail || 'Invalid credentials';
                }
            } catch (err) {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginError').textContent = 'Connection error';
            }
        });

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadOverview();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            adminToken = null;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
                document.getElementById(`page-${page}`).classList.add('active');
                
                document.getElementById('pageTitle').textContent = item.textContent.trim();
                
                // Load page data
                switch(page) {
                    case 'overview': loadOverview(); break;
                    case 'riders': loadRiders(); break;
                    case 'drivers': loadDrivers(); break;
                    case 'trips': loadTrips(); break;
                    case 'payments': loadPayments(); break;
                    case 'verifications': loadVerifications(); break;
                    case 'promos': loadPromos(); break;
                    case 'fraud': loadFraudAlerts(); break;
                    case 'users': break; // Users loaded on search
                    case 'livetrips': loadLiveTrips(); break;
                    case 'analytics': loadAnalytics('today'); break;
                    case 'community': loadCommunity(); break;
                }
            });
        });

        // API Calls
        async function loadOverview() {
            try {
                const res = await fetch(`${API_URL}/admin/overview`);
                const data = await res.json();
                
                document.getElementById('totalRiders').textContent = data.total_riders || 0;
                document.getElementById('totalDrivers').textContent = data.total_drivers || 0;
                document.getElementById('totalTrips').textContent = data.total_trips || 0;
                document.getElementById('totalRevenue').textContent = `‚Ç¶${(data.total_revenue || 0).toLocaleString()}`;
            } catch (err) {
                console.error('Load overview error:', err);
            }
        }

        async function loadRiders() {
            try {
                const res = await fetch(`${API_URL}/admin/riders`);
                const data = await res.json();
                
                document.getElementById('riderCount').textContent = `${data.riders?.length || 0} riders`;
                
                if (data.riders && data.riders.length > 0) {
                    document.getElementById('ridersTable').innerHTML = data.riders.map(r => `
                        <tr>
                            <td>${r.name || 'N/A'}</td>
                            <td>${r.phone || 'N/A'}</td>
                            <td>${r.email || 'N/A'}</td>
                            <td>${r.total_trips || 0}</td>
                            <td><span class="badge ${r.blocked ? 'red' : 'green'}">${r.blocked ? 'Blocked' : 'Active'}</span></td>
                            <td>
                                <button class="action-btn ${r.blocked ? 'approve' : 'block'}" onclick="toggleUserBlock('${r.id}', ${!r.blocked})">
                                    ${r.blocked ? 'Unblock' : 'Block'}
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Load riders error:', err);
            }
        }

        async function loadDrivers() {
            try {
                const res = await fetch(`${API_URL}/admin/drivers`);
                const data = await res.json();
                
                document.getElementById('driverCount').textContent = `${data.drivers?.length || 0} drivers`;
                
                if (data.drivers && data.drivers.length > 0) {
                    document.getElementById('driversTable').innerHTML = data.drivers.map(d => `
                        <tr>
                            <td>${d.name || 'N/A'}</td>
                            <td>${d.phone || 'N/A'}</td>
                            <td>${d.vehicle?.make || 'N/A'} ${d.vehicle?.model || ''}</td>
                            <td><span class="badge ${getSubBadge(d.subscription_status)}">${d.subscription_status || 'None'}</span></td>
                            <td><span class="badge ${d.blocked ? 'red' : 'green'}">${d.blocked ? 'Blocked' : 'Active'}</span></td>
                            <td>
                                <button class="action-btn view" onclick="viewDriver('${d.id}')">View</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Load drivers error:', err);
            }
        }

        async function loadTrips() {
            try {
                const res = await fetch(`${API_URL}/admin/trips`);
                const data = await res.json();
                
                document.getElementById('tripCount').textContent = `${data.trips?.length || 0} trips`;
                
                if (data.trips && data.trips.length > 0) {
                    document.getElementById('tripsTable').innerHTML = data.trips.map(t => `
                        <tr>
                            <td>${t.id?.substring(0,8) || 'N/A'}...</td>
                            <td>${t.rider_name || 'N/A'}</td>
                            <td>${t.driver_name || 'Unassigned'}</td>
                            <td>${t.pickup?.address?.substring(0,20) || 'N/A'}...</td>
                            <td>‚Ç¶${(t.fare || 0).toLocaleString()}</td>
                            <td><span class="badge ${getTripBadge(t.status)}">${t.status || 'Unknown'}</span></td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Load trips error:', err);
            }
        }

        async function loadPayments() {
            try {
                const res = await fetch(`${API_URL}/admin/payments`);
                const data = await res.json();
                
                // Store payments for modal display
                currentPayments = data.payments || [];
                
                document.getElementById('approvedPayments').textContent = data.approved_count || 0;
                document.getElementById('pendingPayments').textContent = data.pending_count || 0;
                document.getElementById('totalSubscriptionRevenue').textContent = `‚Ç¶${(data.total_revenue || 0).toLocaleString()}`;
                
                if (data.payments && data.payments.length > 0) {
                    document.getElementById('paymentsTable').innerHTML = data.payments.map(p => `
                        <tr>
                            <td><strong>${p.driver_name || 'N/A'}</strong></td>
                            <td>‚Ç¶${(p.amount || 25000).toLocaleString()}</td>
                            <td>${p.screenshot ? '<a href="javascript:void(0)" onclick="viewScreenshot(\'' + p.id + '\')" style="color: #6366F1;">View Proof</a>' : '<span style="color:#64748B;">N/A</span>'}</td>
                            <td>${new Date(p.created_at).toLocaleDateString()}</td>
                            <td><span class="badge ${p.status === 'active' || p.status === 'approved' ? 'green' : p.status === 'pending' || p.status === 'pending_verification' ? 'yellow' : 'red'}">${p.auto_approved ? '‚ö° Auto-Approved' : p.status}</span></td>
                            <td>
                                ${p.status === 'pending' || p.status === 'pending_verification' ? `
                                    <button class="action-btn approve" onclick="approvePayment('${p.id}')">Approve</button>
                                    <button class="action-btn block" onclick="rejectPayment('${p.id}')" style="margin-left:8px;">Reject</button>
                                ` : '<span style="color:#22C55E;">‚úì Processed</span>'}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('paymentsTable').innerHTML = '<tr><td colspan="6" class="empty-state"><i class="ri-bank-card-line"></i><p>No payments yet</p></td></tr>';
                }
            } catch (err) {
                console.error('Load payments error:', err);
            }
        }

        async function approvePayment(subscriptionId) {
            if (!confirm('Approve this subscription payment?')) return;
            try {
                await fetch(`${API_URL}/admin/subscriptions/${subscriptionId}/approve`, { method: 'POST' });
                loadPayments();
                alert('Subscription approved successfully!');
            } catch (err) {
                console.error('Approve payment error:', err);
                alert('Failed to approve payment');
            }
        }

        async function rejectPayment(subscriptionId) {
            const reason = prompt('Enter rejection reason:', 'Payment verification failed');
            if (!reason) return;
            try {
                await fetch(`${API_URL}/admin/subscriptions/${subscriptionId}/reject?reason=${encodeURIComponent(reason)}`, { method: 'POST' });
                loadPayments();
                alert('Subscription rejected');
            } catch (err) {
                console.error('Reject payment error:', err);
                alert('Failed to reject payment');
            }
        }

        async function loadVerifications() {
            try {
                const res = await fetch(`${API_URL}/admin/verifications`);
                const data = await res.json();
                
                const pendingCount = data.verifications?.filter(v => v.status === 'pending').length || 0;
                document.getElementById('verificationCount').textContent = `${pendingCount} pending`;
                
                if (data.verifications && data.verifications.length > 0) {
                    document.getElementById('verificationsTable').innerHTML = data.verifications.map(v => `
                        <tr>
                            <td><strong>${v.driver_name || 'N/A'}</strong></td>
                            <td>${v.driver_phone || 'N/A'}</td>
                            <td>
                                ${v.license ? '‚úì License' : '‚úó License'}<br>
                                ${v.vehicle_registration ? '‚úì Registration' : '‚úó Registration'}<br>
                                ${v.insurance ? '‚úì Insurance' : '‚úó Insurance'}
                            </td>
                            <td>${v.vehicle_make || 'N/A'} ${v.vehicle_model || ''}<br><small>${v.vehicle_plate || 'No plate'}</small></td>
                            <td><span class="badge ${getVerificationBadge(v.status)}">${v.status || 'Unknown'}</span></td>
                            <td>
                                ${v.status === 'pending' ? `
                                    <button class="action-btn approve" onclick="approveVerification('${v.driver_id}')">Approve</button>
                                    <button class="action-btn block" onclick="rejectVerification('${v.driver_id}')" style="margin-left:8px;">Reject</button>
                                ` : '<span style="color:#22C55E;">‚úì Processed</span>'}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('verificationsTable').innerHTML = '<tr><td colspan="6" class="empty-state"><i class="ri-shield-check-line"></i><p>No pending verifications</p></td></tr>';
                }
            } catch (err) {
                console.error('Load verifications error:', err);
            }
        }

        async function loadPromos() {
            try {
                const res = await fetch(`${API_URL}/admin/promos`);
                const data = await res.json();
                
                if (data.promos && data.promos.length > 0) {
                    document.getElementById('promosTable').innerHTML = data.promos.map(p => `
                        <tr>
                            <td><strong>${p.code}</strong></td>
                            <td>${p.discount_percent}%</td>
                            <td>${p.used_by?.length || 0}</td>
                            <td>${p.max_uses}</td>
                            <td><span class="badge ${p.active ? 'green' : 'red'}">${p.active ? 'Active' : 'Inactive'}</span></td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Load promos error:', err);
            }
        }

        function getSubBadge(status) {
            if (status === 'active') return 'green';
            if (status === 'trial') return 'blue';
            if (status === 'pending') return 'yellow';
            return 'red';
        }

        function getTripBadge(status) {
            if (status === 'completed') return 'green';
            if (status === 'ongoing') return 'blue';
            if (status === 'pending') return 'yellow';
            return 'red';
        }

        function getVerificationBadge(status) {
            if (status === 'approved') return 'green';
            if (status === 'pending') return 'yellow';
            if (status === 'rejected') return 'red';
            return 'blue';
        }

        async function approveVerification(driverId) {
            if (!confirm('Approve this driver verification?')) return;
            try {
                await fetch(`${API_URL}/admin/verifications/${driverId}/approve`, { method: 'POST' });
                loadVerifications();
                alert('Driver verification approved successfully!');
            } catch (err) {
                console.error('Approve verification error:', err);
                alert('Failed to approve verification');
            }
        }

        async function rejectVerification(driverId) {
            const reason = prompt('Enter rejection reason:', 'Documents incomplete or invalid');
            if (!reason) return;
            try {
                await fetch(`${API_URL}/admin/verifications/${driverId}/reject?reason=${encodeURIComponent(reason)}`, { method: 'POST' });
                loadVerifications();
                alert('Driver verification rejected');
            } catch (err) {
                console.error('Reject verification error:', err);
                alert('Failed to reject verification');
            }
        }

        async function toggleUserBlock(userId, block) {
            try {
                await fetch(`${API_URL}/admin/users/${userId}/block?block=${block}`, { method: 'POST' });
                loadRiders();
                loadDrivers();
            } catch (err) {
                console.error('Toggle block error:', err);
            }
        }

        function showCreatePromo() {
            document.getElementById('promoModal').style.display = 'flex';
        }

        function closePromoModal() {
            document.getElementById('promoModal').style.display = 'none';
        }

        document.getElementById('promoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('promoCode').value.toUpperCase();
            const discount = parseInt(document.getElementById('promoDiscount').value);
            const maxUses = parseInt(document.getElementById('promoMaxUses').value);
            
            try {
                await fetch(`${API_URL}/admin/promo/create?code=${code}&discount_percent=${discount}&max_uses=${maxUses}`, {
                    method: 'POST'
                });
                closePromoModal();
                loadPromos();
            } catch (err) {
                console.error('Create promo error:', err);
            }
        });

        // Store current payment data for modal display
        let currentPayments = [];
        
        function viewScreenshot(subscriptionId) {
            const payment = currentPayments.find(p => p.id === subscriptionId);
            if (payment && payment.screenshot) {
                // Store the current payment ID for approval/rejection
                currentViewingPaymentId = subscriptionId;
                
                // Show modal with the screenshot
                const modal = document.getElementById('screenshotModal');
                const img = document.getElementById('screenshotImage');
                const driverName = document.getElementById('screenshotDriverName');
                const amount = document.getElementById('screenshotAmount');
                const date = document.getElementById('screenshotDate');
                
                img.src = payment.screenshot;
                driverName.textContent = payment.driver_name || 'Unknown Driver';
                amount.textContent = `‚Ç¶${(payment.amount || 25000).toLocaleString()}`;
                date.textContent = payment.payment_submitted_at ? new Date(payment.payment_submitted_at).toLocaleString() : 'N/A';
                
                modal.style.display = 'flex';
            } else {
                alert('No payment proof available for this subscription.');
            }
        }
        
        function closeScreenshotModal() {
            document.getElementById('screenshotModal').style.display = 'none';
            currentViewingPaymentId = null;
        }
        
        // Variable to track which payment is being viewed
        let currentViewingPaymentId = null;
        
        async function approveFromModal() {
            if (currentViewingPaymentId) {
                await approvePayment(currentViewingPaymentId);
                closeScreenshotModal();
            }
        }
        
        async function rejectFromModal() {
            if (currentViewingPaymentId) {
                await rejectPayment(currentViewingPaymentId);
                closeScreenshotModal();
            }
        }
        
        async function viewDriver(driverId) {
            try {
                // Get driver details
                const res = await fetch(`${API_URL}/drivers/${driverId}/profile`);
                const profile = await res.json();
                
                // Get subscription
                const subRes = await fetch(`${API_URL}/subscriptions/${driverId}`);
                const subscription = await subRes.json();
                
                alert(`Driver Profile\n\nVehicle: ${profile.vehicle_model || 'N/A'} (${profile.vehicle_plate || 'N/A'})\nColor: ${profile.vehicle_color || 'N/A'}\nOnline: ${profile.is_online ? 'Yes' : 'No'}\n\nSubscription: ${subscription?.status || 'None'}\nDays Remaining: ${subscription?.days_remaining || 0}`);
            } catch (err) {
                console.error('View driver error:', err);
                alert('Failed to load driver details');
            }
        }

        // ==================== FRAUD ALERTS ====================
        async function loadFraudAlerts() {
            try {
                const res = await fetch(`${API_URL}/admin/fraud/dashboard`);
                const data = await res.json();
                
                document.getElementById('fraudTotal').textContent = data.stats?.total_alerts || 0;
                document.getElementById('fraudCritical').textContent = data.stats?.critical || 0;
                document.getElementById('fraudHigh').textContent = data.stats?.high || 0;
                document.getElementById('fraudMedium').textContent = data.stats?.medium || 0;
                document.getElementById('fraudLow').textContent = data.stats?.low || 0;
                document.getElementById('fraudMessage').textContent = data.message || '';
                
                if (data.alerts && data.alerts.length > 0) {
                    document.getElementById('fraudTable').innerHTML = data.alerts.map(alert => `
                        <tr>
                            <td><span class="badge ${alert.type === 'FAKE_PAYMENT' ? 'red' : alert.type === 'MULTIPLE_ACCOUNTS' ? 'orange' : 'yellow'}">${alert.type.replace(/_/g, ' ')}</span></td>
                            <td><span class="badge ${alert.severity === 'CRITICAL' ? 'red' : alert.severity === 'HIGH' ? 'orange' : alert.severity === 'MEDIUM' ? 'yellow' : 'green'}">${alert.severity}</span></td>
                            <td style="max-width: 300px;">${alert.message}</td>
                            <td>
                                ${alert.user_id ? `<button class="action-btn view" onclick="investigateUser('${alert.user_id}')">Investigate</button>` : 
                                  alert.driver_id ? `<button class="action-btn view" onclick="investigateUser('${alert.driver_id}')">Investigate</button>` : '-'}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('fraudTable').innerHTML = '<tr><td colspan="4" class="empty-state"><i class="ri-shield-check-line"></i><p>No fraud alerts - All clear! ‚úÖ</p></td></tr>';
                }
            } catch (err) {
                console.error('Load fraud alerts error:', err);
            }
        }

        async function investigateUser(userId) {
            try {
                const res = await fetch(`${API_URL}/admin/fraud/investigate/${userId}`, { method: 'POST' });
                const data = await res.json();
                
                let report = `üîç INVESTIGATION REPORT\n\n`;
                report += `User: ${data.user_info?.name || 'Unknown'}\n`;
                report += `Phone: ${data.user_info?.phone || 'N/A'}\n`;
                report += `Role: ${data.user_info?.role || 'N/A'}\n\n`;
                report += `üìä STATS:\n`;
                report += `Total Trips: ${data.stats?.total_trips || 0}\n`;
                report += `Cancelled: ${data.stats?.cancelled_trips || 0} (${data.stats?.cancel_rate || 0}%)\n`;
                report += `SOS Alerts: ${data.stats?.sos_count || 0}\n\n`;
                report += `‚ö†Ô∏è RED FLAGS:\n`;
                report += data.red_flags?.length > 0 ? data.red_flags.join('\n') : 'None found';
                report += `\n\nüéØ RISK: ${data.risk_assessment?.level || 'LOW'}\n`;
                report += `üí° ${data.risk_assessment?.recommendation || 'No action needed'}`;
                
                alert(report);
            } catch (err) {
                console.error('Investigation error:', err);
                alert('Failed to investigate user');
            }
        }

        async function takeFraudAction(userId, action) {
            const reason = prompt(`Enter reason for ${action}:`);
            if (!reason) return;
            
            try {
                const res = await fetch(`${API_URL}/admin/fraud/action/${userId}?action=${action}&reason=${encodeURIComponent(reason)}`, { method: 'POST' });
                const data = await res.json();
                alert(data.message || 'Action completed');
                loadFraudAlerts();
            } catch (err) {
                console.error('Fraud action error:', err);
                alert('Failed to take action');
            }
        }

        // ==================== USER MANAGEMENT ====================
        async function searchUsers() {
            const query = document.getElementById('userSearchInput').value;
            const role = document.getElementById('userRoleFilter').value;
            
            if (!query) {
                alert('Please enter a search term');
                return;
            }
            
            try {
                let url = `${API_URL}/admin/users/search?query=${encodeURIComponent(query)}`;
                if (role) url += `&role=${role}`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.users && data.users.length > 0) {
                    document.getElementById('usersTable').innerHTML = data.users.map(u => `
                        <tr>
                            <td>${u.name || 'N/A'}</td>
                            <td>${u.phone || 'N/A'}</td>
                            <td>${u.email || 'N/A'}</td>
                            <td><span class="badge ${u.role === 'driver' ? 'blue' : 'green'}">${u.role || 'N/A'}</span></td>
                            <td>${u.total_trips || 0}</td>
                            <td>
                                ${u.is_banned ? '<span class="badge red">Banned</span>' : 
                                  u.is_suspended ? '<span class="badge orange">Suspended</span>' : 
                                  '<span class="badge green">Active</span>'}
                            </td>
                            <td>
                                <button class="action-btn view" onclick="viewUserDetails('${u.id}')">View</button>
                                ${u.is_suspended ? 
                                    `<button class="action-btn approve" onclick="unsuspendUser('${u.id}')">Unsuspend</button>` : 
                                    `<button class="action-btn block" onclick="takeFraudAction('${u.id}', 'suspend_7days')">Suspend</button>`}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('usersTable').innerHTML = '<tr><td colspan="7" class="empty-state"><i class="ri-user-search-line"></i><p>No users found</p></td></tr>';
                }
            } catch (err) {
                console.error('Search users error:', err);
            }
        }

        async function viewUserDetails(userId) {
            try {
                const res = await fetch(`${API_URL}/admin/users/${userId}/details`);
                const data = await res.json();
                
                let details = `üë§ USER DETAILS\n\n`;
                details += `Name: ${data.user?.name || 'N/A'}\n`;
                details += `Phone: ${data.user?.phone || 'N/A'}\n`;
                details += `Email: ${data.user?.email || 'N/A'}\n`;
                details += `Role: ${data.user?.role || 'N/A'}\n`;
                details += `Rating: ${data.user?.rating || 5.0}‚≠ê\n`;
                details += `Behavior Score: ${data.user?.behavior_score || 100}\n\n`;
                details += `üìä STATS:\n`;
                details += `Total Trips: ${data.stats?.total_trips || 0}\n`;
                details += `Warnings: ${data.stats?.warnings || 0}\n`;
                details += `Status: ${data.stats?.is_banned ? 'üö´ BANNED' : data.stats?.is_suspended ? '‚è∏Ô∏è SUSPENDED' : '‚úÖ ACTIVE'}`;
                
                alert(details);
            } catch (err) {
                console.error('View user error:', err);
                alert('Failed to load user details');
            }
        }

        async function unsuspendUser(userId) {
            if (!confirm('Are you sure you want to unsuspend this user?')) return;
            
            try {
                const res = await fetch(`${API_URL}/admin/users/${userId}/unsuspend`, { method: 'POST' });
                const data = await res.json();
                alert(data.message || 'User unsuspended');
                searchUsers();
            } catch (err) {
                console.error('Unsuspend error:', err);
                alert('Failed to unsuspend user');
            }
        }

        // ==================== LIVE TRIPS ====================
        async function loadLiveTrips() {
            try {
                const res = await fetch(`${API_URL}/admin/trips/live`);
                const data = await res.json();
                
                document.getElementById('liveTripsCount').textContent = data.count || 0;
                document.getElementById('longTripsCount').textContent = data.long_trips || 0;
                document.getElementById('lastRefresh').textContent = new Date().toLocaleTimeString();
                
                if (data.active_trips && data.active_trips.length > 0) {
                    document.getElementById('liveTripsTable').innerHTML = data.active_trips.map(trip => `
                        <tr>
                            <td style="font-family: monospace; font-size: 12px;">${trip.id?.substring(0, 8) || 'N/A'}...</td>
                            <td>${trip.driver_info?.name || 'N/A'}<br><small style="color: #64748B;">${trip.driver_info?.phone || ''}</small></td>
                            <td>${trip.rider_info?.name || 'N/A'}<br><small style="color: #64748B;">${trip.rider_info?.phone || ''}</small></td>
                            <td><span class="badge ${trip.status === 'started' ? 'green' : trip.status === 'arrived' ? 'blue' : 'yellow'}">${trip.status}</span></td>
                            <td>${trip.duration_mins?.toFixed(1) || 0} min</td>
                            <td>${trip.alert ? `<span style="color: #F97316;">${trip.alert}</span>` : '-'}</td>
                            <td>
                                <button class="action-btn view" onclick="viewTripDetails('${trip.id}')">View</button>
                                <button class="action-btn block" onclick="adminCancelTrip('${trip.id}')">Cancel</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('liveTripsTable').innerHTML = '<tr><td colspan="7" class="empty-state"><i class="ri-car-line"></i><p>No active trips right now</p></td></tr>';
                }
            } catch (err) {
                console.error('Load live trips error:', err);
            }
        }

        async function viewTripDetails(tripId) {
            try {
                const res = await fetch(`${API_URL}/admin/trips/${tripId}/details`);
                const data = await res.json();
                
                let details = `üöó TRIP DETAILS\n\n`;
                details += `ID: ${data.trip?.id || 'N/A'}\n`;
                details += `Status: ${data.trip?.status || 'N/A'}\n`;
                details += `Fare: ‚Ç¶${data.trip?.fare?.toLocaleString() || 0}\n\n`;
                details += `üë§ Driver: ${data.driver?.name || 'N/A'} (${data.driver?.phone || 'N/A'})\n`;
                details += `üë§ Rider: ${data.rider?.name || 'N/A'} (${data.rider?.phone || 'N/A'})\n\n`;
                details += `üìç From: ${data.trip?.pickup_address || 'N/A'}\n`;
                details += `üìç To: ${data.trip?.dropoff_address || 'N/A'}\n`;
                details += `${data.has_issues ? '\n‚ö†Ô∏è This trip has reported issues!' : ''}`;
                
                alert(details);
            } catch (err) {
                console.error('View trip error:', err);
                alert('Failed to load trip details');
            }
        }

        async function adminCancelTrip(tripId) {
            const reason = prompt('Enter cancellation reason:');
            if (!reason) return;
            
            try {
                const res = await fetch(`${API_URL}/admin/trips/${tripId}/cancel?reason=${encodeURIComponent(reason)}`, { method: 'POST' });
                const data = await res.json();
                alert(data.message || 'Trip cancelled');
                loadLiveTrips();
            } catch (err) {
                console.error('Cancel trip error:', err);
                alert('Failed to cancel trip');
            }
        }

        // ==================== ANALYTICS ====================
        let currentPeriod = 'today';
        
        async function loadAnalytics(period) {
            currentPeriod = period;
            
            // Update button styles
            document.getElementById('btn-today').className = period === 'today' ? 'action-btn view' : 'action-btn';
            document.getElementById('btn-week').className = period === 'week' ? 'action-btn view' : 'action-btn';
            document.getElementById('btn-month').className = period === 'month' ? 'action-btn view' : 'action-btn';
            
            try {
                const res = await fetch(`${API_URL}/admin/trips/analytics?period=${period}`);
                const data = await res.json();
                
                document.getElementById('analyticsTrips').textContent = data.total_trips || 0;
                document.getElementById('analyticsCompleted').textContent = data.completed || 0;
                document.getElementById('analyticsCancelRate').textContent = `${data.cancel_rate || 0}%`;
                document.getElementById('analyticsRevenue').textContent = `‚Ç¶${(data.revenue?.total || 0).toLocaleString()}`;
                document.getElementById('analyticsAvgDistance').textContent = `${data.averages?.distance_km || 0} km`;
                document.getElementById('analyticsAvgDuration').textContent = `${data.averages?.duration_mins || 0} min`;
                document.getElementById('analyticsPeakHour').textContent = data.peak_hour || '-';
                
                // Insights
                if (data.insights && data.insights.length > 0) {
                    document.getElementById('analyticsInsights').innerHTML = data.insights.map(i => 
                        `<p style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">${i}</p>`
                    ).join('');
                }
            } catch (err) {
                console.error('Load analytics error:', err);
            }
        }

        // ==================== COMMUNITY ====================
        async function loadCommunity() {
            try {
                // Load stats
                const statsRes = await fetch(`${API_URL}/community/stats?region=lagos`);
                const stats = await statsRes.json();
                
                document.getElementById('communityDrivers').textContent = stats.total_drivers || 0;
                document.getElementById('communityActive').textContent = stats.active_drivers || 0;
                document.getElementById('communityPosts').textContent = stats.total_posts || 0;
                document.getElementById('communityEvents').textContent = stats.total_events || 0;
                
                // Load events
                const eventsRes = await fetch(`${API_URL}/community/events?region=lagos`);
                const eventsData = await eventsRes.json();
                
                if (eventsData.events && eventsData.events.length > 0) {
                    document.getElementById('communityEventsList').innerHTML = eventsData.events.map(e => `
                        <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-weight: 600;">${e.title}</div>
                            <div style="font-size: 12px; color: #64748B;">${new Date(e.event_date).toLocaleDateString()} ‚Ä¢ ${e.location || 'TBD'}</div>
                            <div style="font-size: 12px; color: #00E676; margin-top: 4px;">${e.attendees?.length || 0} attending</div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('communityEventsList').innerHTML = '<p style="color: #64748B;">No upcoming events</p>';
                }
                
                // Load groups
                const groupsRes = await fetch(`${API_URL}/community/groups?region=lagos`);
                const groupsData = await groupsRes.json();
                
                if (groupsData.groups && groupsData.groups.length > 0) {
                    document.getElementById('communityGroupsList').innerHTML = groupsData.groups.map(g => `
                        <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-weight: 600;">${g.name}</div>
                            <div style="font-size: 12px; color: #64748B;">${g.description || 'No description'}</div>
                            <div style="font-size: 12px; color: #6366F1; margin-top: 4px;">${g.members_count || 0} members</div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('communityGroupsList').innerHTML = '<p style="color: #64748B;">No groups yet</p>';
                }
            } catch (err) {
                console.error('Load community error:', err);
            }
        }

        // Add enter key support for user search
        document.getElementById('userSearchInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchUsers();
        });
    </script>
</body>
</html>